<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Minimal three.js GLB Viewer</title>
<style>
  html,body{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;background:#0b0d10;color:#e6e6e6}
  #topbar{position:fixed;inset:12px 12px auto 12px;display:flex;gap:8px;align-items:center;background:rgba(20,22,26,.8);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;z-index:10}
  #topbar input{width:420px;max-width:60vw;background:#0f1216;border:1px solid #2a2f36;color:#ddd;border-radius:10px;padding:8px 10px}
  #topbar button{background:#1e68ff;border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
  #topbar small{opacity:.8}
  #stats{position:fixed;inset:auto 12px 12px 12px;background:rgba(20,22,26,.8);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 12px;display:flex;gap:16px;flex-wrap:wrap}
  #err{position:fixed;left:12px;right:12px;bottom:56px;white-space:pre-wrap;color:#ffb4b4}
  canvas{display:block;width:100%;height:100%}
</style>
</head>
<body>
  <div id="topbar">
    <small>GLB URL</small>
    <input id="url" placeholder="https://example.com/model.glb" />
    <button id="loadBtn">Load</button>
    <button id="fileBtn">Open .glb</button>
    <small id="msg"></small>
  </div>
  <div id="stats"></div>
  <div id="err"></div>
  <canvas id="c"></canvas>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.164/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.164/examples/jsm/loaders/GLTFLoader.js';
import { DRACOLoader } from 'https://unpkg.com/three@0.164/examples/jsm/loaders/DRACOLoader.js';
import { KTX2Loader } from 'https://unpkg.com/three@0.164/examples/jsm/loaders/KTX2Loader.js';
import { OrbitControls } from 'https://unpkg.com/three@0.164/examples/jsm/controls/OrbitControls.js';
import { RoomEnvironment } from 'https://unpkg.com/three@0.164/examples/jsm/environments/RoomEnvironment.js';

const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
resize();

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 100);
camera.position.set(2, 1.2, 2);

const pmrem = new THREE.PMREMGenerator(renderer);
scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;

const controls = new OrbitControls(camera, renderer.domElement);
controls.target.set(0, 0.6, 0);
controls.enableDamping = true;

const draco = new DRACOLoader().setDecoderPath('https://unpkg.com/three@0.164/examples/jsm/libs/draco/');
const ktx2  = new KTX2Loader().setTranscoderPath('https://unpkg.com/three@0.164/examples/jsm/libs/basis/').detectSupport(renderer);
const loader = new GLTFLoader().setDRACOLoader(draco).setKTX2Loader(ktx2);

let current;
function clearModel(){
  if(!current) return;
  scene.remove(current);
  current.traverse?.(o=>{
    if(o.geometry) o.geometry.dispose();
    const m=o.material;
    (Array.isArray(m)?m:[m]).forEach(mm=>{
      ['map','normalMap','roughnessMap','metalnessMap','occlusionMap','emissiveMap'].forEach(k=>mm && mm[k] && mm[k].dispose());
    });
  });
  current=null;
}
function triCount(obj){
  let t=0; obj.traverse(o=>{
    if(o.isMesh){ const g=o.geometry;
      if(g?.index) t+=g.index.count/3;
      else if(g?.attributes?.position) t+=g.attributes.position.count/3;
    }
  }); return Math.round(t);
}
function place(root){
  // center and sit on ground
  new THREE.Box3().setFromObject(root).getCenter(root.position).multiplyScalar(-1);
  const box=new THREE.Box3().setFromObject(root); const size=box.getSize(new THREE.Vector3());
  root.position.y -= box.min.y;
  current=root; scene.add(root);
  // stats
  byId('stats').textContent = `Approx. tris: ${triCount(root).toLocaleString()} | Size: ${size.x.toFixed(2)} × ${size.y.toFixed(2)} × ${size.z.toFixed(2)} m`;
  // frame
  const maxDim=Math.max(size.x,size.y,size.z);
  camera.position.setScalar(maxDim*1.6).setY(maxDim*0.8);
  controls.target.copy(new THREE.Box3().setFromObject(root).getCenter(new THREE.Vector3()));
  controls.update();
}
function setMsg(t){ byId('msg').textContent=t||''; }
function setErr(t){ byId('err').textContent=t||''; }
function byId(id){ return document.getElementById(id); }

function loadFromURL(url){
  setErr(''); setMsg('Loading…'); clearModel();
  loader.load(url, g=>{ place(g.scene); setMsg('Loaded'); }, xhr=>{
    if(xhr.total) setMsg(`Loading ${(xhr.loaded/xhr.total*100).toFixed(0)}%`);
  }, err=>{ console.error(err); setMsg(''); setErr('Error loading model URL (CORS or invalid URL).'); });
}

// Robust local file load (no object URLs)
async function loadLocalFile(file){
  try{
    setErr(''); setMsg('Reading local file…'); clearModel();
    const buffer = await file.arrayBuffer();
    loader.parse(buffer, '', gltf=>{
      place(gltf.scene);
      setMsg(file.name);
    }, err=>{
      console.error(err);
      setMsg('');
      setErr('Error parsing local GLB.');
    });
  }catch(e){
    console.error(e);
    setMsg('');
    setErr('Error reading local file.');
  }
}

// UI
byId('loadBtn').onclick=()=>{
  const u = byId('url').value.trim();
  if(u) loadFromURL(u);
};
byId('fileBtn').onclick=()=>{
  const inp=document.createElement('input');
  inp.type='file';
  inp.accept='.glb,model/gltf-binary,model/gltf+binary,application/octet-stream';
  inp.onchange=()=>{ const f=inp.files?.[0]; if(f) loadLocalFile(f); };
  inp.click();
};

// URL param ?model=
const modelURL=new URLSearchParams(location.search).get('model');
if(modelURL){ byId('url').value=modelURL; loadFromURL(modelURL); }

// resize + render loop
function resize(){ const w=innerWidth,h=innerHeight; renderer.setSize(w,h,false); camera.aspect=w/h; camera.updateProjectionMatrix(); }
addEventListener('resize', resize);
renderer.setAnimationLoop(()=>{ controls.update(); renderer.render(scene,camera); });
</script>
</body>
</html>


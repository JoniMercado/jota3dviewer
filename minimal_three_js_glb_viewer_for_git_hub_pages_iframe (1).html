<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minimal three.js GLB Viewer</title>
  <style>
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif;background:#0b0d10;color:#e6e6e6}
    #topbar{position:fixed;inset:12px 12px auto 12px;display:flex;gap:8px;align-items:center;background:rgba(20,22,26,.8);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;z-index:10}
    #topbar input{width:360px;max-width:48vw;background:#0f1216;border:1px solid #2a2f36;color:#ddd;border-radius:10px;padding:8px 10px}
    #topbar button{background:#1e68ff;border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer}
    #topbar small{opacity:.7}
    #stats{position:fixed;inset:auto 12px 12px 12px;background:rgba(20,22,26,.8);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 12px;display:flex;gap:16px;flex-wrap:wrap}
    #drop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;border:2px dashed #2a2f36;border-radius:16px;background:rgba(30,104,255,.08);color:#cfe0ff;pointer-events:auto}
    canvas{display:block;width:100%;height:100%}
    a{color:#9ac1ff}
  </style>
</head>
<body>
  <div id="topbar">
    <small>GLB URL</small>
    <input id="url" placeholder="https://example.com/model.glb" />
    <button id="loadBtn">Load</button>
    <button id="fileBtn">Open .glb</button>
    <small id="msg"></small>
  </div>
  <div id="stats"></div>
  <div id="drop">Drop a .glb file to view</div>
  <canvas id="c"></canvas>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.164/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.164/examples/jsm/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'https://unpkg.com/three@0.164/examples/jsm/loaders/DRACOLoader.js';
    import { KTX2Loader } from 'https://unpkg.com/three@0.164/examples/jsm/loaders/KTX2Loader.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.164/examples/jsm/controls/OrbitControls.js';
    import { RoomEnvironment } from 'https://unpkg.com/three@0.164/examples/jsm/environments/RoomEnvironment.js';

    const canvas = document.getElementById('c');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: false });
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    resize();

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(2, 1.2, 2);

    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.target.set(0, 0.6, 0);
    controls.enableDamping = true;

    const draco = new DRACOLoader().setDecoderPath('https://unpkg.com/three@0.164/examples/jsm/libs/draco/');
    const ktx2 = new KTX2Loader().setTranscoderPath('https://unpkg.com/three@0.164/examples/jsm/libs/basis/').detectSupport(renderer);

    const loader = new GLTFLoader().setDRACOLoader(draco).setKTX2Loader(ktx2);

    let current;
    function clearModel(){ if(!current) return; scene.remove(current); current.traverse?.(o=>{ if(o.geometry) o.geometry.dispose(); if(o.material){ const m=o.material; if(Array.isArray(m)) m.forEach(disposeMat); else disposeMat(m); }}); current = null; }
    function disposeMat(m){ if(m.map) m.map.dispose(); if(m.normalMap) m.normalMap.dispose(); if(m.roughnessMap) m.roughnessMap.dispose(); if(m.metalnessMap) m.metalnessMap.dispose(); if(m.occlusionMap) m.occlusionMap.dispose(); if(m.emissiveMap) m.emissiveMap.dispose(); }

    function triCount(obj){ let t=0; obj.traverse(o=>{ if(o.isMesh){ const g=o.geometry; if(g && g.index) t += g.index.count/3; else if(g && g.attributes?.position) t += g.attributes.position.count/3; } }); return Math.round(t); }

    async function loadFromURL(url){
      setMsg('Loading…');
      clearModel();
      loader.load(url, (gltf)=>{ place(gltf.scene); setMsg('Loaded'); }, (xhr)=>{
        if(xhr.total) setMsg(`Loading ${(xhr.loaded/xhr.total*100).toFixed(0)}%`);
      }, (err)=>{ setMsg('Error loading model'); console.error(err); });
    }

    function place(root){
      // normalize position to ground and frame
      new THREE.Box3().setFromObject(root).getCenter(root.position).multiplyScalar(-1);
      const box = new THREE.Box3().setFromObject(root);
      const size = box.getSize(new THREE.Vector3());
      root.position.y -= box.min.y; // sit on ground
      current = root; scene.add(root);
      document.getElementById('stats').textContent = `Approx. tris: ${triCount(root).toLocaleString()} | Size: ${size.x.toFixed(2)} × ${size.y.toFixed(2)} × ${size.z.toFixed(2)} m`;
      // frame
      const maxDim = Math.max(size.x, size.y, size.z);
      camera.position.setScalar(maxDim*1.6).setY(maxDim*0.8);
      controls.target.copy(new THREE.Box3().setFromObject(root).getCenter(new THREE.Vector3()));
      controls.update();
    }

    function resize(){
      const w = window.innerWidth, h = window.innerHeight;
      renderer.setSize(w, h, false); camera.aspect = w/h; camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resize);

    // UI
    const urlInput = document.getElementById('url');
    const loadBtn = document.getElementById('loadBtn');
    const fileBtn = document.getElementById('fileBtn');
    const drop = document.getElementById('drop');
    function setMsg(t){ document.getElementById('msg').textContent = t||''; }

    loadBtn.onclick = ()=>{ if(urlInput.value) loadFromURL(urlInput.value.trim()); };
    fileBtn.onclick = ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='.glb,model/gltf-binary';
      inp.onchange = ()=>{ const f = inp.files?.[0]; if(!f) return; loadBlob(f); };
      inp.click();
    };

    function loadBlob(file){ setMsg('Loading local file…'); clearModel(); const url = URL.createObjectURL(file); loader.load(url, (g)=>{ place(g.scene); setMsg(file.name); URL.revokeObjectURL(url); }, undefined, (e)=>{ setMsg('Error with local file'); console.error(e); }); }

    // Drag & drop — robust handlers (enter/over/leave/drop)
    function prevent(e){ e.preventDefault(); e.stopPropagation(); }

    document.addEventListener('dragenter', (e)=>{ prevent(e); drop.style.display='flex'; });
    document.addEventListener('dragover', (e)=>{ prevent(e); drop.style.display='flex'; });
    document.addEventListener('dragleave', (e)=>{ prevent(e); if(e.target===document || e.target===drop){ drop.style.display='none'; } });

    drop.addEventListener('drop', (e)=>{ prevent(e); drop.style.display='none'; const f=e.dataTransfer?.files?.[0]; if(f) loadBlob(f); });
    document.addEventListener('drop', (e)=>{ prevent(e); drop.style.display='none'; const f=e.dataTransfer?.files?.[0]; if(f) loadBlob(f); });

    // URL param support: ?model=...
    const params = new URLSearchParams(location.search);
    const modelURL = params.get('model');
    if(modelURL){ urlInput.value = modelURL; loadFromURL(modelURL); }

    // render
    renderer.setAnimationLoop(()=>{ controls.update(); renderer.render(scene, camera); });
  </script>
</body>
</html>
